name: Deploy Vue (Static)

on:
  push:
    branches: [ master ]   # troque para main se for o seu padrão

concurrency:
  group: vue-static-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # Yarn 4 (Corepack)
      - name: Enable Corepack (Yarn 4)
        run: |
          set -e
          corepack enable
          corepack prepare yarn@stable --activate
          yarn -v

      - name: Install deps (Yarn 4)
        run: yarn install --immutable --check-cache

      - name: Build
        env:
          # use vars (ou secrets) para a URL da API
          VITE_API_URL: ${{ secrets.VITE_API_URL }}
        run: yarn build

      # artefato opcional para inspeção do build
      - name: Archive dist (optional)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist

      # 0) teste rápido de SSH para evitar "i/o timeout" mascarado
      - name: SSH smoke test
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          port: ${{ secrets.SSH_PORT }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          timeout: 120s
          command_timeout: 2m
          script: |
            set -e
            echo "connected as $(whoami) on $(hostname)"
            # cria pastas de trabalho e doc de ACME se necessário
            mkdir -p "${{ secrets.TARGET_DIR }}/__incoming"
            mkdir -p "${{ secrets.TARGET_DIR }}/.well-known"

      # 1) garante que a pasta alvo existe (idempotente)
      - name: Ensure target dir
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          port: ${{ secrets.SSH_PORT }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          timeout: 120s
          command_timeout: 5m
          script: |
            set -e
            mkdir -p "${{ secrets.TARGET_DIR }}/__incoming"
            mkdir -p "${{ secrets.TARGET_DIR }}/.well-known"

      # 2) upload do build estático
      - name: Upload dist via SCP
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          port: ${{ secrets.SSH_PORT }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          source: "dist/*"
          target: "${{ secrets.TARGET_DIR }}/__incoming"
          timeout: 120s
          command_timeout: 15m

      # 3) ativação atômica do novo build
      - name: Activate new build
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          port: ${{ secrets.SSH_PORT }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          timeout: 120s
          command_timeout: 5m
          script: |
            set -e
            cd "${{ secrets.TARGET_DIR }}"

            # backup simples do current
            mkdir -p __backup current
            if [ -d current ] && [ "$(ls -A current)" ]; then
              ts="$(date +%Y%m%d%H%M%S)"
              mkdir -p "__backup/${ts}"
              rsync -a current/ "__backup/${ts}/"
            fi

            # move artefatos novos para "current"
            shopt -s nullglob
            for f in __incoming/*; do mv -f "$f" current/; done
            rm -rf __incoming/*

            # publique para o docroot:
            # -> se o DocumentRoot do Nginx/APache for a RAIZ do TARGET_DIR:
            rsync -a --delete --exclude '.well-known/' current/ ./

            # -> se o DocumentRoot for ./public/, use esta linha no lugar da de cima:
            # rsync -a --delete --exclude '.well-known/' current/ ./public/

            echo "Deploy finalizado em $(date)"
