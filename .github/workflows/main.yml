name: Deploy Vue (npm, simples)

on:
  push:
    branches: [ master ]   # troque para main se for o seu padrão
  workflow_dispatch:

concurrency:
  group: vue-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH (git pull + npm build no servidor)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}      # use o IP
          port: ${{ secrets.SSH_PORT }}      # 22 (ou sua porta)
          username: ${{ secrets.SSH_USER }}  # mesmo usuário do Laravel (se possível)
          key: ${{ secrets.SSH_KEY }}        # privada correspondente ao authorized_keys do usuário
          timeout: 180s
          command_timeout: 20m
          script: |
            set -e
            APP_DIR="${{ secrets.TARGET_DIR }}"   # ex.: /home/agendame-app/htdocs/agendame-app
            echo ">> cd ${APP_DIR}"
            cd "${APP_DIR}"

            echo ">> git fetch / reset hard para origin/master"
            git fetch origin
            git checkout master || true
            git reset --hard origin/master

            echo ">> instalar dependências (npm)"
            if command -v npm >/dev/null 2>&1; then
              npm ci || npm install
            else
              echo "npm não encontrado. Instale Node/npm no VPS."
              exit 1
            fi

            echo ">> build de produção"
            export VITE_API_URL="${{ secrets.VITE_API_URL }}"
            npm run build

            echo ">> conferindo dist/"
            test -d dist || (echo "Build não gerou dist/"; exit 1)
            ls -lah dist | head -n 50

            echo "OK $(date)"
