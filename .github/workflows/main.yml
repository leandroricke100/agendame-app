name: Deploy Vue (Static)

on:
  push:
    branches: [ master ]   # troque para main se for o seu padrão

concurrency:
  group: vue-static-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Enable Corepack (Yarn 4)
        run: |
          set -e
          corepack enable
          corepack prepare yarn@stable --activate
          yarn -v

      - name: Install deps (Yarn 4)
        run: yarn install --immutable --check-cache

      - name: Build
        env:
          VITE_API_URL: ${{ vars.VITE_API_URL }}   # opcional
        run: yarn build

      - name: Archive dist (opcional)
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist

      # garante que a pasta alvo existe
      - name: Ensure target dir
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            set -e
            mkdir -p "${{ secrets.TARGET_DIR }}/__incoming"
            mkdir -p "${{ secrets.TARGET_DIR }}/.well-known"

      - name: Upload dist via SCP
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          source: "dist/*"
          target: "${{ secrets.TARGET_DIR }}/__incoming"
          timeout: 2m
          command_timeout: 15m

      - name: Activate new build
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            set -e
            cd "${{ secrets.TARGET_DIR }}"
            # backup simples (mantém 2 últimos)
            mkdir -p __backup
            if [ -d current ]; then mv -f current "__backup/$(date +%Y%m%d%H%M%S)"; fi
            mkdir -p current
            shopt -s nullglob
            # move o conteúdo novo para "current" (não falha se vazio)
            for f in __incoming/*; do mv -f "$f" current/; done
            rm -rf __incoming/*

            # publique para o docroot:
            # => SE o Document Root for a RAIZ do site:
            rsync -a --delete --exclude '.well-known/' current/ ./

            # => SE o Document Root for ./public/, use esta em vez da de cima:
            # rsync -a --delete --exclude '.well-known/' current/ ./public/

            echo "Deploy finalizado em $(date)"
